{"ast":null,"code":"/* eslint-disable no-underscore-dangle */\n'use strict';\n\nconst fs = require('fs');\n\nconst crypto = require('crypto');\n\nconst {\n  EventEmitter\n} = require('events');\n\nclass PersistentFile extends EventEmitter {\n  constructor(_ref) {\n    let {\n      filepath,\n      newFilename,\n      originalFilename,\n      mimetype,\n      hashAlgorithm\n    } = _ref;\n    super();\n    this.lastModifiedDate = null;\n    Object.assign(this, {\n      filepath,\n      newFilename,\n      originalFilename,\n      mimetype,\n      hashAlgorithm\n    });\n    this.size = 0;\n    this._writeStream = null;\n\n    if (typeof this.hashAlgorithm === 'string') {\n      this.hash = crypto.createHash(this.hashAlgorithm);\n    } else {\n      this.hash = null;\n    }\n  }\n\n  open() {\n    this._writeStream = new fs.WriteStream(this.filepath);\n\n    this._writeStream.on('error', err => {\n      this.emit('error', err);\n    });\n  }\n\n  toJSON() {\n    const json = {\n      size: this.size,\n      filepath: this.filepath,\n      newFilename: this.newFilename,\n      mimetype: this.mimetype,\n      mtime: this.lastModifiedDate,\n      length: this.length,\n      originalFilename: this.originalFilename\n    };\n\n    if (this.hash && this.hash !== '') {\n      json.hash = this.hash;\n    }\n\n    return json;\n  }\n\n  toString() {\n    return `PersistentFile: ${this._file.newFilename}, Original: ${this._file.originalFilename}, Path: ${this._file.filepath}`;\n  }\n\n  write(buffer, cb) {\n    if (this.hash) {\n      this.hash.update(buffer);\n    }\n\n    if (this._writeStream.closed) {\n      cb();\n      return;\n    }\n\n    this._writeStream.write(buffer, () => {\n      this.lastModifiedDate = new Date();\n      this.size += buffer.length;\n      this.emit('progress', this.size);\n      cb();\n    });\n  }\n\n  end(cb) {\n    if (this.hash) {\n      this.hash = this.hash.digest('hex');\n    }\n\n    this._writeStream.end(() => {\n      this.emit('end');\n      cb();\n    });\n  }\n\n  destroy() {\n    this._writeStream.destroy();\n\n    fs.unlink(this.filepath, () => {});\n  }\n\n}\n\nmodule.exports = PersistentFile;","map":{"version":3,"sources":["/Users/bagjuhong/Desktop/ian/node_modules/formidable/src/PersistentFile.js"],"names":["fs","require","crypto","EventEmitter","PersistentFile","constructor","filepath","newFilename","originalFilename","mimetype","hashAlgorithm","lastModifiedDate","Object","assign","size","_writeStream","hash","createHash","open","WriteStream","on","err","emit","toJSON","json","mtime","length","toString","_file","write","buffer","cb","update","closed","Date","end","digest","destroy","unlink","module","exports"],"mappings":"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","sourcesContent":["/* eslint-disable no-underscore-dangle */\n\n'use strict';\n\nconst fs = require('fs');\nconst crypto = require('crypto');\nconst { EventEmitter } = require('events');\n\nclass PersistentFile extends EventEmitter {\n  constructor({ filepath, newFilename, originalFilename, mimetype, hashAlgorithm }) {\n    super();\n\n    this.lastModifiedDate = null;\n    Object.assign(this, { filepath, newFilename, originalFilename, mimetype, hashAlgorithm });\n\n    this.size = 0;\n    this._writeStream = null;\n\n    if (typeof this.hashAlgorithm === 'string') {\n      this.hash = crypto.createHash(this.hashAlgorithm);\n    } else {\n      this.hash = null;\n    }\n  }\n\n  open() {\n    this._writeStream = new fs.WriteStream(this.filepath);\n    this._writeStream.on('error', (err) => {\n      this.emit('error', err);\n    });\n  }\n\n  toJSON() {\n    const json = {\n      size: this.size,\n      filepath: this.filepath,\n      newFilename: this.newFilename,\n      mimetype: this.mimetype,\n      mtime: this.lastModifiedDate,\n      length: this.length,\n      originalFilename: this.originalFilename,\n    };\n    if (this.hash && this.hash !== '') {\n      json.hash = this.hash;\n    }\n    return json;\n  }\n\n  toString() {\n    return `PersistentFile: ${this._file.newFilename}, Original: ${this._file.originalFilename}, Path: ${this._file.filepath}`;\n  }\n\n  write(buffer, cb) {\n    if (this.hash) {\n      this.hash.update(buffer);\n    }\n\n    if (this._writeStream.closed) {\n      cb();\n      return;\n    }\n\n    this._writeStream.write(buffer, () => {\n      this.lastModifiedDate = new Date();\n      this.size += buffer.length;\n      this.emit('progress', this.size);\n      cb();\n    });\n  }\n\n  end(cb) {\n    if (this.hash) {\n      this.hash = this.hash.digest('hex');\n    }\n    this._writeStream.end(() => {\n      this.emit('end');\n      cb();\n    });\n  }\n\n  destroy() {\n    this._writeStream.destroy();\n    fs.unlink(this.filepath, () => {});\n  }\n}\n\nmodule.exports = PersistentFile;\n"]},"metadata":{},"sourceType":"script"}